#!/bin/bash

Title="The GNU C Library (glibc)"
Home="https://www.gnu.org/software/libc/"
Name=glibc
Version=2.27
BuildIn=build
BuildDeps=(linux-headers)
_linuxVersion=4.15.3
Supplies=(
    https://ftpmirror.gnu.org/gnu/$Name/$Name-$Version.tar.xz
    https://www.kernel.org/pub/linux/kernel/v${_linuxVersion:0:1}.x/linux-$_linuxVersion.tar.xz
)

Build() 
{
    local target=/GLIBC

    mkdir --verbose --parents $target
    mkdir --verbose --parents $target/lib
    ln --verbose --symbolic lib $target/lib64
    mkdir --verbose --parents $target/usr
    mkdir --verbose --parents $target/usr/include
    mkdir --verbose --parents $target/usr/lib
    ln --verbose --symbolic lib $target/usr/lib64
    mkdir --verbose --parents $target/etc
    touch $target/etc/ld.so.conf

    pushd ../../linux-4.15.3
    make mrproper
    make INSTALL_HDR_PATH=/$target/usr headers_install
    find $target/usr/include \( -name .install -o -name ..install.cmd \) -delete
    popd

    ../configure \
        --prefix=/usr                               \
        --disable-nls                               \
        --disable-werror                            \
        --enable-kernel=4.0                         \
        --enable-stack-protector=strong             \
        --with-headers=$target/usr/include          \
        --without-gd                                \
        --disable-nscd                              \
        --disable-build-nscd

    make

    touch /etc/ld.so.conf

    bash -l

    make DESTDIR=$target install

    rm $target/lib64
    mkdir $target/lib64
    ln -sfv ../lib/ld-linux-x86-64.so.2 $target/lib64

    bash -l

    return 0

    mkdir -pv /usr/lib/locale
    
    #localedef -i cs_CZ -f UTF-8 cs_CZ.UTF-8
    #localedef -i de_DE -f ISO-8859-1 de_DE
    #localedef -i de_DE@euro -f ISO-8859-15 de_DE@euro
    #localedef -i de_DE -f UTF-8 de_DE.UTF-8
    #localedef -i en_GB -f UTF-8 en_GB.UTF-8
    #localedef -i en_HK -f ISO-8859-1 en_HK
    #localedef -i en_PH -f ISO-8859-1 en_PH
    #localedef -i en_US -f ISO-8859-1 en_US
    #localedef -i en_US -f UTF-8 en_US.UTF-8
    #localedef -i es_MX -f ISO-8859-1 es_MX
    #localedef -i fa_IR -f UTF-8 fa_IR
    #localedef -i fr_FR -f ISO-8859-1 fr_FR
    #localedef -i fr_FR@euro -f ISO-8859-15 fr_FR@euro
    #localedef -i fr_FR -f UTF-8 fr_FR.UTF-8
    #localedef -i it_IT -f ISO-8859-1 it_IT
    #localedef -i it_IT -f UTF-8 it_IT.UTF-8
    #localedef -i ja_JP -f EUC-JP ja_JP
    #localedef -i ru_RU -f KOI8-R ru_RU.KOI8-R
    #localedef -i ru_RU -f UTF-8 ru_RU.UTF-8
    #localedef -i tr_TR -f UTF-8 tr_TR.UTF-8
    #localedef -i zh_CN -f GB18030 zh_CN.GB18030

    make localedata/install-locales

    cat > /etc/nsswitch.conf << "EOF"
# Begin /etc/nsswitch.conf

passwd: files
group: files
shadow: files

hosts: files dns
networks: files

protocols: files
services: files
ethers: files
rpc: files

# End /etc/nsswitch.conf
EOF

    #tar -xf ../../tzdata2018c.tar.gz
    cp --verbose ../../tzdata2018c/* .

    ZONEINFO=/usr/share/zoneinfo
    mkdir -pv $ZONEINFO/{posix,right}

    for tz in etcetera southamerica northamerica europe africa antarctica  \
            asia australasia backward pacificnew systemv; do
        zic -L /dev/null   -d $ZONEINFO       -y "sh yearistype.sh" ${tz}
        zic -L /dev/null   -d $ZONEINFO/posix -y "sh yearistype.sh" ${tz}
        zic -L leapseconds -d $ZONEINFO/right -y "sh yearistype.sh" ${tz}
    done

    cp -v zone.tab zone1970.tab iso3166.tab $ZONEINFO
    zic -d $ZONEINFO -p America/New_York
    unset ZONEINFO

    echo PARTIALLY DONE
}    
