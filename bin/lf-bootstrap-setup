#!/bin/bash

source $(dirname $0)/lf-config

# ~/lfs
#   |
#   +-- bootstrap
#   |   +-- build             overlay upperdir
#   |   +-- consolidated      overlay lowerdir 2
#   |   |   +-- tools         bound to ~/lfs/tools
#   |   |   +-- sources       bound to ~/lfs/sources
#   |   |   +-- <artefacts>   other stuff from builds
#   |   +-- host              overlay lowerdir 1 / shadow of host root
#   |   +-- root              overlay merge / chroot root
#   |   +-- work              overlay workdir
#   |
#   +-- iterim
#   +-- final
#   +-- tools
#   +-- sources

unmount-all $LfsBootstrap

mkdir --parents $LfsBootstrap/{build,consolidated,host,root,work}

CRoot=$LfsBootstrap/consolidated
HRoot=$LfsBootstrap/host
BRoot=$LfsBootstrap/build

mkdir --parents $CRoot/{bin,tools,sources}

mkdir --parents $LfsTop/tools/lib
[[ -h $LfsTop/tools/lib64 ]] || ln -sf lib $LfsTop/tools/lib64

mount --bind $LfsTop/tools $CRoot/tools
mount --bind $LfsTop/sources $CRoot/sources

for dir in bin boot etc home lib lib64 media opt root sbin srv tmp usr var; do
    mkdir --parent $HRoot/$dir
    mount --bind /$dir $HRoot/$dir
done
for dir in dev mnt run; do
    mkdir --parent $HRoot/$dir
    mount --rbind /$dir $HRoot/$dir
done
for dir in proc sys; do
    mkdir --parent $HRoot/$dir
done

ln -sf bash $CRoot/bin/sh

mount --types overlay overlay --options lowerdir=$CRoot:$HRoot,upperdir=$BRoot,workdir=$LfsBootstrap/work $LfsBootstrap/root

mount --types proc proc $LfsBootstrap/root/proc
mount --types sysfs sysfs $LfsBootstrap/root/sys

