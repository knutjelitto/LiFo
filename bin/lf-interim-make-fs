#!/bin/bash

source LifoConfig
Include lf-interim-config

# ~ +
#   lfs
#      +-- bootstrap
#      |
#      +-- interim
#      |   +-- build             overlay upperdir
#      |   +-- addon             overlay lowerdir 2
#      |   +-- base              overlay lowerdir 1 / preliminary root
#      |       +-- tools         bound to ~/lfs/tools
#      |       +-- sources       bound to ~/lfs/sources
#      |   +-- root              overlay merge / chroot root
#      |   +-- work              overlay workdir
#      |
#      +-- final
#      +-- tools
#      +-- sources

InterimMkDir()
{
    local base=$1
    local mode=''
    [[ -n $2 ]] && mode="--mode=$2"
    shift 2
    while (( $# > 0 )); do
        local dir=$base/$1
        shift
        mkdir $verbose --parents $mode $dir
    done
}

InterimSymLn()
{
    local base=$1
    local link=$base/$2
    local target=$3
    
    ln $verbose --symbolic $target $link
}

InterimMkNod()
{
    local base=$1
    local mode="--mode $2"
    local node=$base/$3
    local type=$4
    local major=$5
    local minor=$6

    mknod $mode $node $type $major $minor
}

[[ -n $InterimBase ]] || exit 255

rm $verbose --recursive $InterimBase
mkdir $verbose --parents $InterimBase

InterimMkDir $InterimBase 0775 tools
InterimMkDir $InterimBase 0775 sources
InterimMkDir $InterimBase 0775 dev
InterimMkDir $InterimBase 0775 proc
InterimMkDir $InterimBase 0775 sys
InterimMkDir $InterimBase 0775 run
InterimMkDir $InterimBase 0775 bin
InterimMkDir $InterimBase 0775 boot
InterimMkDir $InterimBase 0775 etc
InterimMkDir $InterimBase 0775 etc/opt
InterimMkDir $InterimBase 0775 etc/sysconfig
InterimMkDir $InterimBase 0775 home
InterimMkDir $InterimBase 0775 lib
InterimMkDir $InterimBase 0775 lib/firmware
InterimMkDir $InterimBase 0775 lib64
InterimMkDir $InterimBase 0775 mnt
InterimMkDir $InterimBase 0775 opt
InterimMkDir $InterimBase 0775 media
InterimMkDir $InterimBase 0775 media/floppy
InterimMkDir $InterimBase 0775 media/cdrom
InterimMkDir $InterimBase 0775 sbin
InterimMkDir $InterimBase 0775 srv
InterimMkDir $InterimBase 0750 root
InterimMkDir $InterimBase 0750 root/lifo
InterimMkDir $InterimBase 1777 tmp
InterimMkDir $InterimBase 0775 var
InterimMkDir $InterimBase 1777 var/tmp
InterimMkDir $InterimBase 0775 var/log
InterimMkDir $InterimBase 0775 var/mail
InterimMkDir $InterimBase 0775 var/spool
InterimMkDir $InterimBase 0775 var/opt
InterimMkDir $InterimBase 0775 var/cache
InterimMkDir $InterimBase 0775 var/lib
InterimMkDir $InterimBase 0775 var/lib/color
InterimMkDir $InterimBase 0775 var/lib/misc
InterimMkDir $InterimBase 0775 var/lib/locate
InterimMkDir $InterimBase 0775 usr/bin
InterimMkDir $InterimBase 0775 usr/include
InterimMkDir $InterimBase 0775 usr/lib
InterimMkDir $InterimBase 0775 usr/sbin
InterimMkDir $InterimBase 0775 usr/src
InterimMkDir $InterimBase 0775 usr/share
InterimMkDir $InterimBase 0775 usr/share/color
InterimMkDir $InterimBase 0775 usr/share/dict
InterimMkDir $InterimBase 0775 usr/share/doc
InterimMkDir $InterimBase 0775 usr/share/info
InterimMkDir $InterimBase 0775 usr/share/locale
InterimMkDir $InterimBase 0775 usr/share/man
InterimMkDir $InterimBase 0775 usr/share/misc
InterimMkDir $InterimBase 0775 usr/share/terminfo
InterimMkDir $InterimBase 0775 usr/share/zoneinfo
InterimMkDir $InterimBase 0775 usr/libexec
InterimMkDir $InterimBase 0775 usr/share/man/man1
InterimMkDir $InterimBase 0775 usr/share/man/man2
InterimMkDir $InterimBase 0775 usr/share/man/man3
InterimMkDir $InterimBase 0775 usr/share/man/man4
InterimMkDir $InterimBase 0775 usr/share/man/man5
InterimMkDir $InterimBase 0775 usr/share/man/man6
InterimMkDir $InterimBase 0775 usr/share/man/man7
InterimMkDir $InterimBase 0775 usr/share/man/man8

InterimMkNod $InterimBase 0600 dev/console c 5 1
InterimMkNod $InterimBase 0666 dev/null    c 1 3

InterimSymLn $InterimBase var/run  /run
InterimSymLn $InterimBase var/lock /run/lock

mount $verbose --bind /dev $InterimBase/dev
mount $verbose --types devpts devpts $InterimBase/dev/pts --options gid=5,mode=620
mount $verbose --types proc proc $InterimBase/proc
mount $verbose --types sysfs sysfs $InterimBase/sys
mount $verbose --types tmpfs tmpfs $InterimBase/run

InterimMkDir $InterimBase 1777 run/lock
InterimMkDir $InterimBase 1777 run/shm
InterimMkDir $InterimBase 0775 run/mount

InterimSymLn $InterimBase bin/bash    /tools/bin/bash
InterimSymLn $InterimBase bin/sh      bash
InterimSymLn $InterimBase bin/cat     /tools/bin/cat
InterimSymLn $InterimBase bin/dd      /tools/bin/dd
InterimSymLn $InterimBase bin/echo    /tools/bin/echo
InterimSymLn $InterimBase bin/ln      /tools/bin/ln
InterimSymLn $InterimBase bin/pwd     /tools/bin/pwd
InterimSymLn $InterimBase bin/rm      /tools/bin/rm
InterimSymLn $InterimBase bin/stty    /tools/bin/stty

InterimSymLn $InterimBase usr/bin/install /tools/bin/install
InterimSymLn $InterimBase usr/bin/perl    /tools/bin/perl
InterimSymLn $InterimBase usr/bin/env     /tools/bin/env

InterimSymLn $InterimBase usr/lib/libgcc_s.so     /tools/lib/libgcc_s.so
InterimSymLn $InterimBase usr/lib/libgcc_s.so.1   /tools/lib/libgcc_s.so.1

InterimSymLn $InterimBase usr/lib/libstdc++.a     /tools/lib/libstdc++.a
InterimSymLn $InterimBase usr/lib/libstdc++.so    /tools/lib/libstdc++.so
InterimSymLn $InterimBase usr/lib/libstdc++.so.6  /tools/lib/libstdc++.so.6

InterimSymLn $InterimBase etc/mtab                /proc/self/mounts 

touch $InterimBase/var/log/{btmp,lastlog,faillog,wtmp}
chgrp $verbose +13 $InterimBase/var/log/lastlog
chmod $verbose 0664  $InterimBase/var/log/lastlog
chmod $verbose 0600  $InterimBase/var/log/btmp

#find $InterimBase ! -path "$InterimBase/dev/*" ! -path "$InterimBase/proc/*" ! -path "$InterimBase/sys/*" -ls | cut --characters=26- | less

mount $verbose --bind $LfsTop/tools $InterimBase/tools
mount $verbose --bind $LfsTop/sources $InterimBase/sources
mount $verbose --bind $LifoTop $InterimBase/root/lifo

cat > $InterimBase/etc/passwd << "EOF"
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/bin/false
daemon:x:6:6:Daemon User:/dev/null:/bin/false
messagebus:x:18:18:D-Bus Message Daemon User:/var/run/dbus:/bin/false
nobody:x:99:99:Unprivileged User:/dev/null:/bin/false
EOF

cat > $InterimBase/etc/group << "EOF"
root:x:0:
bin:x:1:daemon
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
usb:x:14:
cdrom:x:15:
adm:x:16:
messagebus:x:18:
systemd-journal:x:23:
input:x:24:
mail:x:34:
nogroup:x:99:
users:x:999:
EOF
