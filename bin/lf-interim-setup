#!/bin/bash

source $(dirname $0)/lf-config

# ~/lfs
#   +-- bootstrap
#   |
#   +-- interim
#   |   +-- build             overlay upperdir
#   |   +-- add               overlay lowerdir 2
#   |   +-- base              overlay lowerdir 1 / preliminary root
#   |       +-- tools         bound to ~/lfs/tools
#   |       +-- sources       bound to ~/lfs/sources
#   |   +-- root              overlay merge / chroot root
#   |   +-- work              overlay workdir
#   |
#   +-- final
#   +-- tools
#   +-- sources

unmount-all $LfsInterim

mkdir --verbose --parents $LfsInterim/{build,consolidated,interim,root,work}

CRoot=$LfsInterim/consolidated
HRoot=$LfsInterim/interim
BRoot=$LfsInterim/build

mkdir --verbose --parents $CRoot/{bin,tools,sources}

mkdir --parents $LfsTop/tools/lib
[[ -h $LfsTop/tools/lib64 ]] || ln -sf lib $LfsTop/tools/lib64

mount --bind $LfsTop/tools $CRoot/tools
mount --bind $LfsTop/sources $CRoot/sources

for dir in bin boot etc home lib lib64 media opt root sbin srv tmp usr var; do
    mkdir --parent $HRoot/$dir
    mount --bind /$dir $HRoot/$dir
done
for dir in dev mnt run; do
    mkdir --parent $HRoot/$dir
    mount --rbind /$dir $HRoot/$dir
done
for dir in proc sys; do
    mkdir --parent $HRoot/$dir
done

ln -sf bash $CRoot/bin/sh

mount --types overlay overlay --options lowerdir=$CRoot:$HRoot,upperdir=$BRoot,workdir=$LfsInterim/work $LfsInterim/root

mount --types proc proc $LfsInterim/root/proc
mount --types sysfs sysfs $LfsInterim/root/sys

