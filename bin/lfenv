#!/bin/bash

verbose='--verbose'
verbose=''

source $(dirname $0)/tools/init.sh

# ~/lfs
#     +-- bootstrap
#         +-- build             tmpfs 
#             +-- tmp           overlay workdir
#             +-- root          overlay upperdir
#                 +-- sources   bound to ~/lfs/sources
#                 +-- tools     installation target
#         +-- consolidated      overlay lowerdir 2
#             +-- tools         consolidated from previous builds
#             +-- <artefacts>   other stuff from builds
#         +-- host              overlay lowerdir 1 / shadow of host root
#         +-- root              overlay merge / chroot root
#     +-- iterim
#     +-- final
#     +-- sources

Boot=${LfsTop}/bootstrap

export LFS=${Boot}/root

mkdir ${verbose} --parents ${Boot}/{build,consolidated/{bin,tools},host,root}

#mount ${verbose} --types tmpfs tmpfs ${Boot}/build

mkdir ${verbose} --parents ${Boot}/build/{tmp,root/{sources,tools}}

mount ${verbose} --bind ${LifoTop}/tools ${Boot}/consolidated/tools

for dir in bin boot etc home lib lib64 media opt root sbin srv tmp usr var; do
    mkdir ${verbose} --parent ${Boot}/host/${dir}
    mount ${verbose} --bind /${dir} ${Boot}/host/${dir}
done
for dir in dev mnt run sys; do
    mkdir ${verbose} --parent ${Boot}/host/${dir}
    mount ${verbose} --rbind /${dir} ${Boot}/host/${dir}
done

mkdir ${verbose} --parent ${Boot}/host/proc
mount ${verbose} --types proc proc ${Boot}/host/proc

mount ${verbose} --types overlay overlay \
    --options lowerdir=${Boot}/consolidated:${Boot}/host,upperdir=${Boot}/build/root,workdir=${Boot}/build/tmp ${Boot}/root

chroot "$LFS" /tools/bin/env -i                     \
    HOME=${HOME}                                    \
    TERM="$TERM"                                    \
    PS1='(boot chroot) \u:\w\$ '                    \
    PATH=/bin:/usr/bin:/sbin:/usr/sbin:/tools/bin   \
    /tools/bin/bash +h
echo "EXIT chroot"

unmount-all root/lfs


