#!/bin/bash -e

[[ -z ${_recipeFunctionsIncluded:-} ]] || exit
_recipeFunctionsIncluded=true

RecipeRequiredVars=(Title Name Version Supplies)
RecipeOptionalVars=(BuildIn Redirect)
RecipeRequiredFuncs=()
RecipeOptionalFuncs=(Prepare Configure Build Install Trim)

RecipeUnset() { unset "${RecipeRequiredVars[@]}" "${RecipeRequiredFuncs[@]}" "${RecipeOptionalVars[@]}" "${RecipeOptionalFuncs[@]}"; }

FindRecipe()
{
    local token=$1
    local recipe=/LiFo/Recipes/$token/Recipe

    if [[ ! -r $recipe ]]; then
        Fatal "nothing found for recipe token '$token'"
    fi

    echo $recipe
}

SourceRecipe()
{
    if [[ -z $1 ]]; then
        Fatal "no recipe token given"
    fi

    local token=$1

    RecipeUnset

    Recipe=$(FindRecipe $token)
    RecipeStore=$(dirname $Recipe)
    
    source $Recipe

    while [[ -n ${Redirect:-} ]]; do
        echo "Redirecting $token -> $Redirect"
        token=$Redirect
        Unset
        Recipe=$(FindRecipe $token)
        source $Recipe
    done

    local variable
    for variable in "${RecipeRequiredVars[@]}"; do
        if [[ ! -v ${variable} ]]; then
            Fatal "required variable '$variable' missing in receipe '$token' at '$Recipe'"
        fi
    done
    local function
    for function in "${RecipeRequiredFuncs[@]}"; do
        if [[ ! "$(type -t $function)" == "function" ]]; then
            Fatal "required function '$function' missing in receipe '$token' at '$Recipe'"
        fi
    done
}
