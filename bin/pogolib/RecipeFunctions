#!/bin/bash -eu (source-only)

[[ -z ${_recipeFunctionsIncluded:-} ]] || exit
_recipeFunctionsIncluded=true

RecipeRequiredVars=(Title Name Version Supplies)
RecipeOptionalVars=(BuildIn Redirect)
RecipeRequiredFuncs=()
RecipeOptionalFuncs=(Prepare Configure Build Install Trim)

RecipeUnset() { unset "${RecipeRequiredVars[@]}" "${RecipeRequiredFuncs[@]}" "${RecipeOptionalVars[@]}" "${RecipeOptionalFuncs[@]}"; }

FindRecipe()
{
    local token=$1
    local recipe=/LiFo/Recipes/$token/Recipe

    case $token in
        .*)
            recipe=$(cd $(dirname $token); echo $(pwd)/$(basename $token))
            ;;
        /*)
            recipe=$(cd $(dirname $token); echo $(pwd)/$(basename $token))
            ;;
        *)
            recipe=/LiFo/Recipes/$token/Recipe
            ;;
    esac

    if [[ ! -r $recipe ]]; then
        Fatal "nothing found for recipe token '$token'"
    fi

    echo $recipe
}

SourceRecipe()
{
    if [[ -z $1 ]]; then
        Fatal "no recipe token given"
    fi

    Token=$1

    RecipeUnset

    Recipe=$(FindRecipe $Token)
    RecipeStore=$(dirname $Recipe)
    
    source $Recipe

    while [[ -n ${Redirect:-} ]]; do
        echo "Redirecting $Token -> $Redirect"
        Token=$Redirect
        Unset
        Recipe=$(FindRecipe $Token)
        source $Recipe
    done

    local variable
    for variable in "${RecipeRequiredVars[@]}"; do
        if [[ ! -v ${variable} ]]; then
            Fatal "required variable '$variable' missing in receipe '$Token' at '$Recipe'"
        fi
    done
    local function
    for function in "${RecipeRequiredFuncs[@]}"; do
        if [[ ! "$(type -t $function)" == "function" ]]; then
            Fatal "required function '$function' missing in receipe '$Token' at '$Recipe'"
        fi
    done
    for function in "${RecipeOptionalFuncs[@]}"; do
        if [[ ! "$(type -t $function)" == "function" ]]; then
            eval "$function () { true; }"
        fi
    done
}
