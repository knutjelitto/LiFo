#!/bin/bash -eu

Import PogoConfig
Import PogoFunctions
Import RecipeFunctions
Import BuildFunctions

InChroot && Fatal "please don't call in chroot (toplevel only)"

#verbose=''

Token=${1:-}

BuildSetupRecipe $Token

blacklist=$(mktemp)
bom=$(mktemp)

cat > $blacklist << "EOF"
 /$
 /tmp.*
 /Data.*
 /bin$
 /include$
EOF

topDir=$BuildChanges/Data/Compile/Tools

Pushd $topDir

(
    find . -mindepth 1 \( -type l -printf '%y %M %4m %3n %10s /%P -> %l\n' -o -printf '%y %M %4m %3n %10s /%P\n' \)
) | grep -v -f $blacklist >$bom


echo XXX
cat $bom | less
echo YYY

cat $bom | cut -c 35- | \
tar --create --file - \
    --verbatim-files-from --files-from=- --directory=$topDir | \
tar --extract --verbose --directory=$PogoTools

Popd

rm $verbose --force $blacklist $bom
