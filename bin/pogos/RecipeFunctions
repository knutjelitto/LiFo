#!/bin/bash -eu (source-only)

[[ -z ${_recipeFunctionsIncluded:-} ]] || exit
_recipeFunctionsIncluded=true

RecipeRequiredVars=(Title Name Version Supplies)
RecipeOptionalVars=(BuildIn)
RecipeRequiredFuncs=()
RecipeOptionalFuncs=(Prepare Build Trim)

declare Recipe_File Recipe_Coll
declare Recipe_BuildHome Recipe_StoreHome

RecipeFind2 ()
{
    # sets global Recipe_Coll / Recipe_File

    local collection="$(dirname $Recipe_Token)"
    local recipe="$(basename $Recipe_Token)"
    declare -p collection
    declare -p recipe

    if [[ "$collection" == "." ]]; then
        collection=Core
    fi
    if [[ ! -d "$Recipes_Home/$collection" ]]; then
        Fatal "invalid recipe token - no '$collection' collection found"
    fi

    for Recipe_Coll in "${Recipes_Collections[@]}"; do
        Recipe_File="$Recipes_Home/$Recipe_Coll/$Recipe_Token"
        if [[ ! -f $Recipe_File ]]; then
            for Recipe_File in "$Recipes_Home/$Recipe_Coll/$Recipe_Token"-*; do
                if [[ -f $Recipe_File ]]; then
                    return
                fi
            done
        fi
        if [[ ! -f $Recipe_File ]]; then
            Recipe_File="$Recipes_Home/$Recipe_Coll/$Recipe_Token/Recipe"
        fi
        if [[ -f $Recipe_File ]]; then
            return
        fi
    done

    if [[ ! -f Recipe_File ]]; then
        Fatal "can't resolve recipe token '$Recipe_Token'"
    fi
}

RecipeFind ()
{
    # sets global Recipe_Coll / Recipe_File

    for Recipe_Coll in "${Recipes_Collections[@]}"; do
        Recipe_File="$Recipes_Home/$Recipe_Coll/$Recipe_Token"
        if [[ ! -f $Recipe_File ]]; then
            for Recipe_File in "$Recipes_Home/$Recipe_Coll/$Recipe_Token"-*; do
                if [[ -f $Recipe_File ]]; then
                    return
                fi
            done
        fi
        if [[ ! -f $Recipe_File ]]; then
            Recipe_File="$Recipes_Home/$Recipe_Coll/$Recipe_Token/Recipe"
        fi
        if [[ -f $Recipe_File ]]; then
            return
        fi
    done

    if [[ ! -f Recipe_File ]]; then
        Fatal "can't resolve recipe token '$Recipe_Token'"
    fi
}

RecipeUnset () 
{ 
    unset "${RecipeRequiredVars[@]}" "${RecipeRequiredFuncs[@]}" "${RecipeOptionalVars[@]}" "${RecipeOptionalFuncs[@]}"
}

RecipeSource ()
{
    local content
    content=$(_recipeSource ${1:-})
    eval "$content"
}

_recipeSource ()
{
    Recipe_Token=${1:-}

    if [[ -z $Recipe_Token ]]; then
        Fatal "no recipe token given"
    fi

    RecipeUnset
    RecipeFind
    
    source $Recipe_File

    local savedRecipe_Coll="$Recipe_Coll"
    while [[ -n "${Redirect:-}" ]]; do
        Recipe_Token="$Redirect"
        unset Redirect
        RecipeUnset
        RecipeFind
        source $Recipe_File
    done
    Recipe_Coll="$savedRecipe_Coll"

    local variable
    for variable in "${RecipeRequiredVars[@]}"; do
        if [[ ! -v ${variable} ]]; then
            Fatal "required variable '$variable' missing in receipe '$Recipe_Token' at '$Recipe_File'"
        fi
    done
    for variable in "${RecipeOptionalVars[@]}"; do
        if [[ ! -v ${variable} ]]; then
            eval "declare $variable=''"
        fi
    done
    local function
    for function in "${RecipeRequiredFuncs[@]}"; do
        if [[ ! "$(type -t $function)" == "function" ]]; then
            Fatal "required function '$function' missing in receipe '$Recipe_Token' at '$Recipe_File'"
        fi
    done
    for function in "${RecipeOptionalFuncs[@]}"; do
        if [[ ! "$(type -t $function)" == "function" ]]; then
            eval "$function () { :; }"
        fi
    done

    declare -p Recipe_Token | sed 's/ -- / -g /'
    declare -p Recipe_Coll | sed 's/ -- / -g /'
    declare -p Recipe_File | sed 's/ -- / -g /'
    declare -p Title | sed 's/-- Title=/-g Recipe_Title=/'
    declare -p Name | sed 's/-- Name=/-g Recipe_Name=/'
    declare -p Version | sed 's/-- Version=/-g Recipe_Version=/'
    declare -p Supplies | sed 's/-a Supplies=/-ga Recipe_Supplies=/'
    declare -p BuildIn | sed 's/-- BuildIn=/-g Recipe_BuildIn=/'
    echo -n 'Recipe_' ; declare -pf Prepare
    echo -n 'Recipe_' ; declare -pf Build
    echo -n 'Recipe_' ; declare -pf Trim
}
