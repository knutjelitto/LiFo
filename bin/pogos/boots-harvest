#!/bin/bash -eu

Import PogoConfig
NeverInChroot

BuildSetupRecipe ${1:-}

Header "HARVEST $Recipe_Coll / $Recipe_Title"

OnCleanup ()
{
    rm $verbose --force ${blackout:-undefined}
}

trap OnCleanup EXIT

topDir=$BuildChanges/Data/Compile/Lfs/tools

[[ -d "$topDir" ]] || InfoExit "nothing to harvest"

StoreLocation=$PogoStore/$Recipe_Coll/$Recipe_Name/$Recipe_Version

Pushd $topDir

MakeDir $StoreLocation
BomFile=$StoreLocation/Bom

blackout=$(mktemp)

cat > $blackout << 'EOF'
/\ttmp.*/ { next; }
/\tData.*/ { next; }
/\tbin$/ { next; }
/\tshare$/ { next; }
/\tshare\/man$/ { next; }
/\tshare\/man\/.*/ { next; }
/\tshare\/info$/ { next; }
/\tshare\/info\/.*/ { next; }
/\tshare\/doc$/ { next; }
/\tshare\/doc\/.*/ { next; }
/.*/ { print $0 }
EOF

MakeBom ()
{
    (
        cd $topDir
        find . -mindepth 1 \( -type l -printf '%y\t%M\t%4m\t%3n\t%10s\t%P\t%l\n' -o -printf '%y\t%M\t%4m\t%3n\t%10s\t%P\n' \)
    ) | gawk -f $blackout >$BomFile
}

ListFiles () { cat $BomFile | awk '/^f\t/ { print $6 }'; }
ListKnown () { cat $BomFile | awk '/^[dfl]\t/ { print $6 }'; }
ListUnknown () { cat $BomFile | awk '/^[dfl]\t/ { next } /.*/ { print $0 }'; }

Validate ()
{
    cat $BomFile | gawk '/^[dfl]\t/ { next } /.*/ { print $0; exit 1; }' || Fatal "unkown entry in bill of material"
}

Strip ()
{
    cd $topDir

    StripUnneeded ()
    {
        [[ -z $verbose ]] || echo strip --strip-unneeded $1
        strip --strip-unneeded $1
    }

    StripDebug ()
    {
        [[ -z $verbose ]] || echo strip --strip-debug $1
        strip --strip-debug $1
    }

    ListFiles | file -i -f - | while read name type; do
        name=${name%:}
        case $type in
            application/x-executable*)  StripUnneeded $name ;;
            application/x-sharedlib*)   StripDebug $name ;;
            application/x-object*)      StripDebug $name ;;
            application/x-archive*)     StripDebug $name ;;
        esac
    done
}

Transfer ()
{
    tar $verbose --create --no-recursion --verbatim-files-from --files-from=- --directory=$topDir --auto-compress --file $StoreLocation/Files.tar.xz
    tar $verbose --extract --directory=$PogoTools --file=$StoreLocation/Files.tar.xz
}

MakeBom
Validate
Strip

ListKnown | Transfer

Popd
