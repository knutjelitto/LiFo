#!/bin/bash

#
# creating a root fs for the [tools] box
#

rootfs=/tmp/rootfs

RootFsMkDir ()
{
    local mode="--mode=$1"
    shift 1
    while (( $# > 0 )); do
        local dir=$rootfs/$1
        shift
        mkdir $verbose --parents $mode $dir
    done
}

RootFsSymLn ()
{
    local link=$rootfs/$1
    local target=$2
    
    ln $verbose --symbolic $target $link
}

RootFsMkDir 0775 bin
RootFsMkDir 0775 sbin
RootFsMkDir 0775 etc
RootFsMkDir 0775 lib
RootFsMkDir 0775 lib64
RootFsMkDir 1777 tmp
RootFsMkDir 1777 dev
RootFsMkDir 1777 proc
RootFsMkDir 1777 sys
RootFsMkDir 0775 run
RootFsMkDir 0775 run/lock
RootFsMkDir 0775 var
RootFsMkDir 1777 var/tmp
RootFsMkDir 0775 var/log
RootFsMkDir 0775 var/cache
RootFsMkDir 0775 var/lib
RootFsMkDir 0775 usr/bin
RootFsMkDir 0775 usr/sbin
RootFsMkDir 0775 usr/include
RootFsMkDir 0775 usr/lib
RootFsMkDir 0775 usr/share
RootFsMkDir 0775 usr/share/color
RootFsMkDir 0775 usr/share/dict
RootFsMkDir 0775 usr/share/doc
RootFsMkDir 0775 usr/share/info
RootFsMkDir 0775 usr/share/locale
RootFsMkDir 0775 usr/share/man
RootFsMkDir 0775 usr/share/misc
RootFsMkDir 0775 usr/share/terminfo
RootFsMkDir 0775 usr/share/zoneinfo
RootFsMkDir 0775 usr/libexec
RootFsMkDir 0775 usr/share/man/man{1..8}

RootFsSymLn bin/bash    /tools/bin/bash
RootFsSymLn bin/sh      bash
RootFsSymLn bin/cat     /tools/bin/cat
RootFsSymLn bin/dd      /tools/bin/dd
RootFsSymLn bin/echo    /tools/bin/echo
RootFsSymLn bin/ln      /tools/bin/ln
RootFsSymLn bin/pwd     /tools/bin/pwd
RootFsSymLn bin/rm      /tools/bin/rm
RootFsSymLn bin/stty    /tools/bin/stty

RootFsSymLn usr/bin/install /tools/bin/install
RootFsSymLn usr/bin/perl    /tools/bin/perl
RootFsSymLn usr/bin/env     /tools/bin/env

RootFsSymLn usr/lib/libgcc_s.so     /tools/lib/libgcc_s.so
RootFsSymLn usr/lib/libgcc_s.so.1   /tools/lib/libgcc_s.so.1

RootFsSymLn usr/lib/libstdc++.a     /tools/lib/libstdc++.a
RootFsSymLn usr/lib/libstdc++.so    /tools/lib/libstdc++.so
RootFsSymLn usr/lib/libstdc++.so.6  /tools/lib/libstdc++.so.6

cat > $rootfs/etc/passwd << "EOF"
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/bin/false
nobody:x:99:99:Unprivileged User:/dev/null:/bin/false
EOF

cat > $rootfs/etc/group << "EOF"
root:x:0:
bin:x:1:daemon
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
usb:x:14:
cdrom:x:15:
adm:x:16:
input:x:24:
mail:x:34:
nogroup:x:99:
users:x:999:
EOF

pushd $rootfs >/dev/null
tar -c -v -a -f /LiFo/docker/tools/rootfs.tar.xz .
popd >/dev/null