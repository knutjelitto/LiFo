#!/bin/bash

source LifoConfig

RequiredVars=(Title Name Version Supplies)
OptionalVars=(Redirect)
RequiredFuncs=()
OptionalFuncs=(Prepare Configure Build Install Trim)

RenameFunction()
{
    local prefix=$1
    local function=$2
    if [[ "$(type -t $function)" == "function" ]]; then
        echo -n "$prefix"
        declare -f $function
    else
        echo "$prefix$function ()"
        echo "{"
        echo "    true"
        echo "}"
    fi
}

RenameVariable()
{
    local prefix=$1
    local variable=$2
    if [[ -n ${!variable} ]]; then
        echo -n "declare -- $prefix"
        declare -p $variable | cut --characters=12-
    else
        echo "declare -- $prefix$variable=''"
    fi
}

Rename()
{
    local prefix=$1
    local temp=$(mktemp)

    RenameVariable $prefix Name         >>$temp
    RenameVariable $prefix Title        >>$temp
    RenameVariable $prefix Version      >>$temp
    RenameVariable $prefix Supplies     >>$temp
    RenameFunction $prefix Configure    >>$temp
    RenameFunction $prefix Build        >>$temp
    RenameFunction $prefix Install      >>$temp
    RenameFunction $prefix Trim         >>$temp

    cat $temp

    source $temp

    rm $temp
}

Unset() { unset "${RequiredVars[@]}" "${RequiredFuncs[@]}" "${OptionalVars[@]}" "${OptionalFuncs[@]}"; }

FindRecipe()
{
    local token=$1
    local script=$token

    [[ -r $script ]] || script=$LifoLfsInterim/$token
    [[ -r $script ]] || script=$(ls -1 ${script}* 2>/dev/null | head --lines=1)
    [[ -r $script ]] || script=$LifoRecipes/$token/Recipe

    if [[ ! -r $script ]]; then
        Fatal "no recipe found for token '$token'"
    fi

    echo $script
}

SourceRecipe()
{
    if [[ -z $1 ]]; then
        Fatal "no recipe token given"
    fi

    local token=$1

    Unset

    Recipe=$(FindRecipe $token)
    source $Recipe

    while [[ -n $Redirect ]]; do
        echo "Redirecting $token -> $Redirect"
        token=$Redirect
        Unset
        Recipe=$(FindRecipe $token)
        source $Recipe
    done

    local variable
    for variable in "${RequiredVars[@]}"; do
        if [[ -z ${!variable} ]]; then
            Fatal "required variable '$variable' missing in receipe '$token' at '$Recipe'"
        fi
    done
    local function
    for function in "${RequiredFuncs[@]}"; do
        if [[ ! "$(type -t $function)" == "function" ]]; then
            Fatal "required function '$function' missing in receipe '$token' at '$Recipe'"
        fi
    done
}
